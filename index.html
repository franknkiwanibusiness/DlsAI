<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyBet AI - Live & Researched</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f0f7ff; --card: #ffffff; --accent: #ff6b6b; --ai-purple: #a29bfe; --border: 4px solid #2d3436; }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-family: 'Fredoka One'; font-size: 3rem; color: var(--accent); text-shadow: 3px 3px 0px #2d3436; margin-bottom: 10px; }
        .status-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .badge { padding: 8px 15px; border-radius: 15px; border: var(--border); font-weight: bold; background: white; box-shadow: 3px 3px 0px #2d3436; }
        #grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; }
        .card { background: var(--card); border: var(--border); border-radius: 20px; padding: 15px; box-shadow: 8px 8px 0px #2d3436; transition: 0.2s; }
        .match-row { display: flex; justify-content: space-between; align-items: center; font-weight: 800; margin: 10px 0; }
        .odds-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .odd-btn { border: 2px solid #2d3436; border-radius: 10px; padding: 5px; text-align: center; font-size: 0.9rem; font-weight: 800; background: #f1f2f6; }
        .ai-btn { width: 100%; margin-top: 15px; background: var(--ai-purple); border: 3px solid #2d3436; padding: 8px; border-radius: 12px; cursor: pointer; font-family: 'Fredoka One'; box-shadow: 3px 3px 0px #2d3436; }
        .ai-result { display: none; margin-top: 10px; padding: 10px; background: #f9f9f9; border-left: 4px solid var(--ai-purple); font-size: 0.8rem; border-radius: 8px; }
    </style>
</head>
<body>

    <h1>GoalGetter AI</h1>
    <div class="status-bar">
        <div id="quota" class="badge">Tokens: --</div>
        <button onclick="forceRefresh()" class="badge" style="background:#4ecdc4; cursor:pointer;">Refresh Games â†»</button>
    </div>

    <div id="grid">
        <div style="grid-column: 1/-1; text-align:center; padding:50px;">Lacing boots... âš½</div>
    </div>

    <script>
        const ODDS_KEY = 'ad7cc474657e32a32bf5d56e68e84fa8';
        const VERCEL_URL = 'https://dlsvalue.site/api/research'; 
        const leagues = ['soccer_epl', 'soccer_spain_la_liga', 'soccer_germany_bundesliga', 'soccer_italy_serie_a', 'soccer_france_ligue_1'];
        
        // Dynamic key based on the date
        const storageKey = `fixtures_${new Date().toLocaleDateString('en-CA')}`;

        async function initApp() {
            const cached = localStorage.getItem(storageKey);
            const savedQuota = localStorage.getItem('last_quota');
            
            if (cached) {
                console.log("Loading from storage...");
                document.getElementById('quota').innerText = `Tokens: ${savedQuota || 'Saved'}`;
                render(JSON.parse(cached));
            } else {
                fetchFixtures();
            }
        }

        async function fetchFixtures() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">Fetching Live Odds...</div>';
            
            try {
                let all = [];
                let quotaVal = "--";
                for (let l of leagues) {
                    const res = await fetch(`https://api.the-odds-api.com/v4/sports/${l}/odds/?apiKey=${ODDS_KEY}&regions=uk&markets=h2h`);
                    quotaVal = res.headers.get('x-requests-remaining') || quotaVal;
                    const data = await res.json();
                    if (Array.isArray(data)) all = [...all, ...data];
                }

                // Save to local storage
                localStorage.setItem(storageKey, JSON.stringify(all));
                localStorage.setItem('last_quota', quotaVal);
                
                document.getElementById('quota').innerText = `Tokens: ${quotaVal}`;
                render(all);
            } catch (e) {
                grid.innerHTML = '<div style="color:red;">Error: Check Odds API Key.</div>';
            }
        }

        function forceRefresh() {
            localStorage.removeItem(storageKey);
            fetchFixtures();
        }

        function render(matches) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            matches.forEach((m, index) => {
                const bookie = m.bookmakers[0];
                const h2h = bookie?.markets[0]?.outcomes || [];
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="font-size:0.7rem; font-weight:800; color:#636e72;">${m.sport_title}</div>
                    <div class="match-row">
                        <span>${m.home_team}</span>
                        <span style="color:var(--accent)">VS</span>
                        <span>${m.away_team}</span>
                    </div>
                    <div class="odds-grid">
                        ${h2h.map(o => `<div class="odd-btn"><div>${o.name}</div>${o.price}</div>`).join('')}
                    </div>
                    <button class="ai-btn" onclick="getAIResearch('${m.home_team}', '${m.away_team}', ${index})">ASK GROQ AI ðŸ§ </button>
                    <div id="ai-res-${index}" class="ai-result">Thinking...</div>
                `;
                grid.appendChild(card);
            });
        }

        async function getAIResearch(home, away, id) {
            const resBox = document.getElementById(`ai-res-${id}`);
            resBox.style.display = 'block';
            resBox.innerText = "ðŸ§  Analyzing form and data...";
            
            try {
                const res = await fetch(VERCEL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ home, away })
                });
                const data = await res.json();
                resBox.innerHTML = `<strong>Pick: ${data.pick}</strong><br><em>"${data.reason}"</em>`;
            } catch (e) {
                resBox.innerText = "AI connection failed. Check Vercel URL.";
            }
        }

        // Run init on start
        initApp();
    </script>
</body>
</html>
