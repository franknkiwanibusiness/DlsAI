<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyBet AI - Smart Odds</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f7ff; --card: #ffffff; --accent: #ff6b6b;
            --ai-purple: #a29bfe; --border: 4px solid #2d3436;
        }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-family: 'Fredoka One'; font-size: 3rem; color: var(--accent); text-shadow: 3px 3px 0px #2d3436; margin: 0; }
        
        .badge { padding: 5px 12px; border-radius: 12px; border: var(--border); font-weight: bold; background: white; box-shadow: 3px 3px 0px #2d3436; margin: 5px; }
        
        #grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; width: 100%; max-width: 1200px; margin-top: 30px; }
        
        .card { background: var(--card); border: var(--border); border-radius: 25px; padding: 20px; box-shadow: 8px 8px 0px #2d3436; position: relative; }
        
        .ai-header { background: var(--ai-purple); border-bottom: var(--border); margin: -20px -20px 15px -20px; padding: 10px; border-radius: 20px 20px 0 0; display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 0.8rem; }
        
        .match { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-weight: 800; font-size: 1.1rem; }
        
        .odds-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .odd-box { border: 2px solid #2d3436; border-radius: 12px; padding: 10px; text-align: center; background: #f1f2f6; }
        .odd-box.highlight { background: #1dd1a1; color: white; }
        
        .reasoning { font-size: 0.8rem; font-style: italic; color: #636e72; background: #f9f9f9; padding: 10px; border-radius: 10px; border-left: 5px solid var(--ai-purple); margin: 10px 0; }
    </style>
</head>
<body>

    <h1>EasyBet AI</h1>
    <div style="display:flex; flex-wrap: wrap; justify-content: center;">
        <div id="quota" class="badge">Tokens: --</div>
        <button id="refresh" class="badge" style="cursor:pointer; background: var(--ai-purple);">Run AI Research â†»</button>
    </div>

    <div id="grid">
        <div style="grid-column: 1/-1; text-align: center; font-family: 'Fredoka One'; padding: 50px;">Waiting for kickoff... âš½</div>
    </div>

    <script>
        const ODDS_KEY = 'ad7cc474657e32a32bf5d56e68e84fa8';
        const VERCEL_URL = '/api/research'; // Replace with your actual deployed Vercel URL
        const leagues = ['soccer_epl', 'soccer_spain_la_liga', 'soccer_germany_bundesliga', 'soccer_italy_serie_a', 'soccer_france_ligue_1'];

        async function runResearch() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">ðŸ§  Groq is researching matchups...</div>';
            
            try {
                // 1. Get all matches for today
                let fixtures = [];
                for (let league of leagues) {
                    const res = await fetch(`https://api.the-odds-api.com/v4/sports/${league}/odds/?apiKey=${ODDS_KEY}&regions=uk&markets=h2h,btts,totals`);
                    const data = await res.json();
                    if (Array.isArray(data)) fixtures = [...fixtures, ...data];
                }

                // Filter for today
                const today = fixtures.filter(m => new Date(m.commence_time).toDateString() === new Date().toDateString());
                
                grid.innerHTML = '';
                
                // 2. Process each match with AI
                for (let match of today.slice(0, 10)) { // Limit to 10 to save your Groq/Vercel usage
                    const aiRes = await fetch(VERCEL_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ home: match.home_team, away: match.away_team })
                    });
                    const research = await aiRes.json();
                    
                    renderCard(match, research);
                }
            } catch (err) {
                grid.innerHTML = 'Error connecting to system. Check Vercel logs.';
            }
        }

        function renderCard(match, ai) {
            const grid = document.getElementById('grid');
            const card = document.createElement('div');
            card.className = 'card';

            // Find the odds for the market Groq suggested
            const bookie = match.bookmakers[0];
            const market = bookie.markets.find(m => m.key === ai.market) || bookie.markets[0];
            
            let oddsHtml = '';
            market.outcomes.forEach(o => {
                const isPick = o.name.includes(ai.pick) || o.name === ai.pick;
                oddsHtml += `
                    <div class="odd-box ${isPick ? 'highlight' : ''}">
                        <div style="font-size: 0.7rem;">${o.name}</div>
                        <div style="font-weight: 800;">${o.price}</div>
                    </div>`;
            });

            card.innerHTML = `
                <div class="ai-header">
                    <span>ðŸ¤– AI INSIGHT</span>
                    <span style="margin-left:auto; background:white; padding:2px 6px; border-radius:5px;">${ai.market.toUpperCase()}</span>
                </div>
                <div class="match">
                    <span>${match.home_team}</span>
                    <span style="font-family:'Fredoka One'; color:var(--accent);">VS</span>
                    <span>${match.away_team}</span>
                </div>
                <div class="reasoning">"${ai.reason}"</div>
                <div class="odds-container">${oddsHtml}</div>
            `;
            grid.appendChild(card);
        }

        document.getElementById('refresh').onclick = runResearch;
        runResearch();
    </script>
</body>
</html>
