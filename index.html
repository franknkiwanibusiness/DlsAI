<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemma AI Picks</title>
    <style>
        :root {
            --ios-bg: #f2f2f7; --ios-card: #ffffff; --ios-blue: #007aff;
            --ios-green: #34c759; --ios-secondary: #8e8e93; --ios-border: #c6c6c8;
            --text: #000000;
        }
        body.dark {
            --ios-bg: #000000; --ios-card: #1c1c1e; --ios-blue: #0a84ff;
            --ios-border: #38383a; --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui; }
        body { background: var(--ios-bg); color: var(--text); padding-bottom: 150px; transition: 0.3s; }

        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(var(--ios-bg), 0.85); backdrop-filter: blur(20px);
            padding: 20px 16px 10px; border-bottom: 0.5px solid var(--ios-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }

        .card {
            background: var(--ios-card); border-radius: 14px; 
            margin: 12px; padding: 16px; border: 1px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .card.selected { border-color: var(--ios-blue); }

        .match-header { font-size: 11px; color: var(--ios-secondary); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        
        .ai-pick-container {
            background: rgba(52, 199, 89, 0.1); border-radius: 10px; padding: 12px;
            border: 1px dashed var(--ios-green); margin-top: 10px;
        }
        .ai-label { font-size: 10px; color: var(--ios-green); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .market-name { font-size: 15px; font-weight: 600; }
        .odds-value { float: right; color: var(--ios-blue); font-weight: 800; }

        .scout-report { 
            font-size: 12px; margin-top: 10px; padding-top: 10px; 
            border-top: 0.5px solid var(--ios-border); line-height: 1.4; display: none;
        }

        .tab-bar {
            position: fixed; bottom: 0; width: 100%; height: 85px;
            background: var(--ios-card); border-top: 0.5px solid var(--ios-border);
            display: flex; padding-bottom: 20px;
        }
        .tab-item { flex: 1; text-align: center; color: var(--ios-secondary); padding-top: 10px; cursor: pointer; }
        .tab-item.active { color: var(--ios-blue); }

        /* Slip Styles */
        .bottom-slip {
            position: fixed; bottom: 85px; width: 100%; height: 60px;
            background: var(--ios-blue); color: white; display: flex;
            align-items: center; justify-content: space-between; padding: 0 20px;
            font-weight: 700; z-index: 99;
        }
    </style>
</head>
<body class="dark">

<header>
    <h1 id="view-title">Gemma AI</h1>
    <div onclick="toggleSettings()" style="font-size: 20px;">‚öôÔ∏è</div>
</header>

<div id="main-content"></div>

<div class="bottom-slip">
    <div>R<span id="stake-label">10</span> @ <span id="total-odds">1.00</span></div>
    <div id="payout-label">R0.00</div>
</div>

<nav class="tab-bar">
    <div class="tab-item active" onclick="fetchAndAnalyze('soccer_epl', 'Premier League', this)">
        <div style="font-size:22px">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø</div><div class="tab-label">EPL</div>
    </div>
    <div class="tab-item" onclick="fetchAndAnalyze('soccer_spain_la_liga', 'La Liga', this)">
        <div style="font-size:22px">üá™üá∏</div><div class="tab-label">LaLiga</div>
    </div>
    <div class="tab-item" onclick="fetchAndAnalyze('soccer_italy_serie_a', 'Serie A', this)">
        <div style="font-size:22px">üáÆüáπ</div><div class="tab-label">Serie A</div>
    </div>
</nav>

<script>
    const ODDS_API_KEY = '826ccd6998728ab23f00ac7ad0546c2b';
    let selections = new Map();
    let stake = localStorage.getItem('gemma_stake') || 10;

    async function fetchAndAnalyze(sportKey, title, el) {
        document.getElementById('view-title').innerText = title;
        document.getElementById('main-content').innerHTML = '<div style="text-align:center; padding:50px; color:#888;">Analyzing Markets...</div>';
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');

        try {
            const url = `https://api.the-odds-api.com/v4/sports/${sportKey}/odds/?apiKey=${ODDS_API_KEY}&regions=uk&markets=h2h,totals&oddsFormat=decimal`;
            const response = await fetch(url);
            const data = await response.json();
            renderAIContent(data);
        } catch (error) {
            document.getElementById('main-content').innerHTML = `<div style="color:red; text-align:center; padding:20px;">Check API Key</div>`;
        }
    }

    function gemmaBrain(match) {
        const bookie = match.bookmakers[0];
        if (!bookie) return { market: "No Market", odd: 1.00 };
        const h2h = bookie.markets.find(m => m.key === 'h2h');
        const homePrice = h2h?.outcomes.find(o => o.name === match.home_team)?.price || 3.0;
        const awayPrice = h2h?.outcomes.find(o => o.name === match.away_team)?.price || 3.0;
        
        // Favorite Logic
        if (homePrice < 1.70) return { market: `${match.home_team} Win`, odd: homePrice };
        if (awayPrice < 1.70) return { market: `${match.away_team} Win`, odd: awayPrice };
        
        // Goals Logic
        const totals = bookie.markets.find(m => m.key === 'totals');
        const over25 = totals?.outcomes.find(o => o.name === 'Over' && o.point === 2.5);
        return over25 ? { market: "Over 2.5 Goals", odd: over25.price } : { market: "Home Draw No Bet", odd: (homePrice * 0.8).toFixed(2) };
    }

    function renderAIContent(matches) {
        const container = document.getElementById('main-content');
        container.innerHTML = matches.map((match, i) => {
            const pick = gemmaBrain(match);
            return `
                <div class="card" id="card-${i}" onclick="toggleSelect('${i}', ${pick.odd}, '${match.home_team}', '${match.away_team}')">
                    <div class="match-header">${match.home_team} vs ${match.away_team}</div>
                    <div class="ai-pick-container">
                        <div class="ai-label">‚ú® GEMMA AI BEST OUTCOME</div>
                        <div>
                            <span class="market-name">${pick.market}</span>
                            <span class="odds-value">@${pick.odd}</span>
                        </div>
                    </div>
                    <div class="scout-report" id="scout-${i}"></div>
                </div>
            `;
        }).join('');
    }

    function toggleSelect(id, odd, h, a) {
        const el = document.getElementById(`card-${id}`);
        const scout = document.getElementById(`scout-${id}`);
        if (selections.has(id)) {
            selections.delete(id);
            el.classList.remove('selected');
            scout.style.display = 'none';
        } else {
            selections.set(id, odd);
            el.classList.add('selected');
            scout.style.display = 'block';
            scout.innerText = "Consulting Gemma...";
            fetchScout(h, a, id);
        }
        updateSlip();
    }

    async function fetchScout(home, away, id) {
        try {
            const res = await fetch('/api/scout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ home, away })
            });
            const data = await res.json();
            document.getElementById(`scout-${id}`).innerText = data.report;
        } catch (e) { document.getElementById(`scout-${id}`).innerText = "No injury alerts."; }
    }

    function updateSlip() {
        let total = 1;
        selections.forEach(v => total *= v);
        if (selections.size === 0) total = 0;
        document.getElementById('total-odds').innerText = total.toFixed(2);
        let p = Math.min(total * stake, 2000000);
        document.getElementById('payout-label').innerText = "R" + p.toLocaleString();
    }

    function toggleSettings() {
        let newStake = prompt("Set Stake (R):", stake);
        if(newStake) {
            stake = newStake;
            localStorage.setItem('gemma_stake', stake);
            document.getElementById('stake-label').innerText = stake;
            updateSlip();
        }
        document.body.classList.toggle('dark');
    }

    fetchAndAnalyze('soccer_epl', 'Premier League');
</script>
</body>
</html>
