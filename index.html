<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* New Styles for the Dual-Stage Button and Quota */
        .stage-1 { background: var(--ai-purple) !important; }
        .stage-2 { background: var(--yellow) !important; color: #000 !important; }
        .verified-card { border: 3px solid var(--green) !important; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
        .risky-card { border: 3px solid var(--accent) !important; opacity: 0.8; }
        .non-bettable { background: #450a0a !important; border: 3px solid #ef4444 !important; }
        .quota-container { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <header>
        <h1>GoalGetter AI</h1>
        <div class="status-bar">
            <div id="q-odds" class="badge">Odds: --</div>
            <div id="q-groq" class="badge">Groq: --</div>
            <div id="q-gemini" class="badge">Gemini: --</div>
            <button onclick="forceRefresh()" class="badge" style="color:var(--yellow); cursor:pointer;">‚Üª Refresh</button>
        </div>
    </header>
    <div id="grid"></div>

    <script>
        const VERCEL_GROQ = '/api/groq.js';
        const VERCEL_GEMMA = '/api/gemma.js';
        let tempResearch = {}; // Stores Groq data temporarily

        async function runAI(home, away, id) {
            const btn = document.getElementById(`btn-${id}`);
            const panel = document.getElementById(`ai-${id}`);
            const card = btn.closest('.card');

            // STAGE 1: GROQ ANALYST
            if (!tempResearch[id]) {
                btn.innerText = "‚è≥ Groq Analyzing...";
                panel.style.display = 'block';
                panel.innerHTML = "üì° Analyst (Groq) calculating markets...";

                try {
                    const res = await fetch(VERCEL_GROQ, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ home, away })
                    });
                    
                    // Update Quota Header
                    const q = res.headers.get('x-ratelimit-remaining-requests');
                    if(q) document.getElementById('q-groq').innerText = `Groq: ${q}`;

                    tempResearch[id] = await res.json();
                    
                    // Change Button to Stage 2
                    btn.innerText = "üîç Final Audit (Gemini)";
                    btn.className = "ai-btn stage-2";
                    panel.innerHTML = "‚úÖ Groq analysis complete. Run Final Audit to verify.";
                } catch (e) { panel.innerText = "Groq Failed."; }
                return;
            }

            // STAGE 2: GEMINI AUDITOR
            btn.innerText = "üß¨ Gemini Researching...";
            const groqData = tempResearch[id];

            try {
                const res = await fetch(VERCEL_GEMMA, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ home, away, groq_suggestion: groqData })
                });
                
                const geminiData = await res.json();
                
                // Final Comparison Logic
                const isVerified = geminiData.decision === "AGREE" && geminiData.confidence > 70;

                if (isVerified) {
                    card.classList.add('verified-card');
                    btn.style.display = "none";
                    panel.innerHTML = `
                        <div style="color:var(--green); font-weight:800; margin-bottom:10px;">üõ°Ô∏è VERIFIED BY DUAL AI</div>
                        <div class="ai-market-row"><span>Main Pick</span> <span class="ai-val">${groqData.pick}</span></div>
                        <div class="ai-market-row"><span>Confidence</span> <span class="ai-val">${geminiData.confidence}%</span></div>
                        <div class="ai-market-row"><span>Goals</span> <span class="ai-val">${groqData.goals}</span></div>
                        <div class="ai-reason">${geminiData.audit_reason}</div>
                    `;
                } else {
                    card.classList.add('non-bettable');
                    btn.style.display = "none";
                    panel.innerHTML = `
                        <div style="color:#ef4444; font-weight:800;">‚ö†Ô∏è NON-BETTABLE</div>
                        <p style="font-size:0.75rem;">Gemini vetoed this fixture. Reason: ${geminiData.audit_reason}</p>
                    `;
                }
                
                // Clean up memory
                delete tempResearch[id];
            } catch (e) { panel.innerText = "Audit Failed."; }
        }

        // Modified Render function to include unique ID for buttons
        function render(matches) {
            const grid = document.getElementById('grid');
            grid.innerHTML = matches.map((m, i) => {
                // ... [Your existing odds calculation logic] ...
                return `
                <div class="card" id="card-${i}">
                    <span class="margin-tag">Vig: ${margin}%</span>
                    <span class="league-tag">${m.sport_title}</span>
                    <div class="match-row"><span>${m.home_team}</span><span style="color:var(--accent)">VS</span><span>${m.away_team}</span></div>
                    <div class="odds-grid">
                        <div class="odd-btn">1: ${h}<span class="prob-label">${probs[0]}%</span></div>
                        <div class="odd-btn">X: ${d}<span class="prob-label">${probs[1]}%</span></div>
                        <div class="odd-btn">2: ${a}<span class="prob-label">${probs[2]}%</span></div>
                    </div>
                    <button id="btn-${i}" class="ai-btn stage-1" onclick="runAI('${m.home_team}', '${m.away_team}', ${i})">DEEP RESEARCH üß†</button>
                    <div id="ai-${i}" class="ai-panel"></div>
                </div>`;
            }).join('');
        }
        // ... [Include init and forceRefresh from your original code] ...
    </script>
</body>
</html>
