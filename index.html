<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoalGetter AI - Pro Research 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --ai-purple: #818cf8; --border: 2px solid #334155; --green: #22c55e; --yellow: #fbbf24; --text: #f8fafc; }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        header { text-align: center; margin-bottom: 20px; width: 100%; }
        h1 { font-family: 'Fredoka One'; font-size: 2.5rem; color: var(--accent); margin: 0; }
        .badge { padding: 8px 15px; border-radius: 12px; border: var(--border); background: #1e293b; font-weight: bold; font-size: 0.8rem; margin: 5px; }
        #grid { display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; max-width: 450px; }
        @media (min-width: 768px) { #grid { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); max-width: 1200px; } }
        .card { background: var(--card); border: var(--border); border-radius: 20px; padding: 20px; position: relative; transition: 0.3s; }
        .margin-tag { position: absolute; top: 15px; right: 15px; font-size: 0.7rem; color: #94a3b8; }
        .match-row { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 1.1rem; margin: 15px 0; }
        .odds-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .odd-btn { background: #334155; border-radius: 10px; padding: 10px; text-align: center; font-size: 0.9rem; }
        .prob-label { display: block; font-size: 0.65rem; color: #38bdf8; margin-top: 4px; font-weight: bold; }
        .ai-btn { width: 100%; background: var(--ai-purple); color: white; border: none; padding: 12px; border-radius: 12px; font-family: 'Fredoka One'; cursor: pointer; }
        .ai-panel { display: none; margin-top: 15px; padding: 15px; background: #0f172a; border-radius: 12px; border-left: 4px solid var(--ai-purple); }
        .ai-market-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .ai-val { color: var(--accent); font-weight: 800; }
        .ai-pct { font-size: 0.7rem; color: #22c55e; margin-left: 5px; }
        .ai-reason { font-size: 0.8rem; font-style: italic; color: #94a3b8; margin-top: 10px; line-height: 1.4; }
    </style>
</head>
<body>
    <header>
        <h1>GoalGetter AI</h1>
        <div class="status-bar">
            <div id="quota" class="badge">API: --</div>
            <button onclick="forceRefresh()" class="badge" style="color:var(--yellow); cursor:pointer;">‚Üª Refresh</button>
        </div>
    </header>
    <div id="grid"></div>

    <script>
        const ODDS_KEY = 'ad7cc474657e32a32bf5d56e68e84fa8';
        const VERCEL_URL = '/api/research'; 
        const leagues = ['soccer_epl', 'soccer_spain_la_liga', 'soccer_germany_bundesliga', 'soccer_italy_serie_a', 'soccer_france_ligue_1'];
        const storageKey = `gg_cache_${new Date().toLocaleDateString('en-CA')}`;

        function calcMargin(h, d, a) {
            if (h === '-' || d === '-' || a === '-') return { margin: 0, probs: [0, 0, 0] };
            const rawProbs = [1/h, 1/d, 1/a];
            const sum = rawProbs.reduce((s, p) => s + p, 0);
            return { 
                margin: ((sum - 1) * 100).toFixed(1),
                probs: rawProbs.map(p => ((p / sum) * 100).toFixed(0))
            };
        }

        async function init() {
            const cached = localStorage.getItem(storageKey);
            if (cached) render(JSON.parse(cached)); else fetchData();
        }

        async function fetchData() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">Analyzing Markets... ‚è≥</div>';
            try {
                let all = [];
                let q = "--";
                for (let l of leagues) {
                    const res = await fetch(`https://api.the-odds-api.com/v4/sports/${l}/odds/?apiKey=${ODDS_KEY}&regions=uk&markets=h2h`);
                    q = res.headers.get('x-requests-remaining') || q;
                    const d = await res.json();
                    if (Array.isArray(d)) all = [...all, ...d];
                }
                localStorage.setItem(storageKey, JSON.stringify(all));
                localStorage.setItem('gg_quota', q);
                document.getElementById('quota').innerText = `Remaining: ${q}`;
                render(all);
            } catch (e) { grid.innerHTML = 'Error loading matches.'; }
        }

        function forceRefresh() { localStorage.removeItem(storageKey); fetchData(); }

        function render(matches) {
            const grid = document.getElementById('grid');
            grid.innerHTML = matches.map((m, i) => {
                const bookie = m.bookmakers[0];
                const h2h = bookie?.markets[0]?.outcomes || [];
                const h = h2h.find(o => o.name === m.home_team)?.price || '-';
                const d = h2h.find(o => o.name === 'Draw')?.price || '-';
                const a = h2h.find(o => o.name === m.away_team)?.price || '-';
                const { margin, probs } = calcMargin(h, d, a);
                return `
                <div class="card">
                    <span class="margin-tag">Vig: ${margin}%</span>
                    <span class="league-tag">${m.sport_title}</span>
                    <div class="match-row"><span>${m.home_team}</span><span style="color:var(--accent)">VS</span><span>${m.away_team}</span></div>
                    <div class="odds-grid">
                        <div class="odd-btn">1: ${h}<span class="prob-label">${probs[0]}%</span></div>
                        <div class="odd-btn">X: ${d}<span class="prob-label">${probs[1]}%</span></div>
                        <div class="odd-btn">2: ${a}<span class="prob-label">${probs[2]}%</span></div>
                    </div>
                    <button class="ai-btn" onclick="runAI('${m.home_team}', '${m.away_team}', ${i})">DEEP RESEARCH üß†</button>
                    <div id="ai-${i}" class="ai-panel"></div>
                </div>`;
            }).join('');
        }

        async function runAI(home, away, id) {
            const panel = document.getElementById(`ai-${id}`);
            panel.style.display = 'block';
            panel.innerHTML = "üîç Calculating 30-day Form & Tactical Edge...";
            try {
                const res = await fetch(VERCEL_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ home, away })
                });
                const data = await res.json();
                panel.innerHTML = `
                    <div class="ai-market-row"><span>Main Pick</span> <span class="ai-val">${data.pick} <span class="ai-pct">${data.pick_pct}%</span></span></div>
                    <div class="ai-market-row"><span>Goals</span> <span class="ai-val">${data.goals} <span class="ai-pct">${data.goals_pct}%</span></span></div>
                    <div class="ai-market-row"><span>Corners</span> <span class="ai-val">${data.corners} <span class="ai-pct">${data.corners_pct}%</span></span></div>
                    <div class="ai-market-row"><span>BTTS</span> <span class="ai-val">${data.btts} <span class="ai-pct">${data.btts_pct}%</span></span></div>
                    <div class="ai-market-row"><span>1st Half G</span> <span class="ai-val">${data.fh_goals}</span></div>
                    <div class="ai-market-row"><span>First Score</span> <span class="ai-val">${data.first_score}</span></div>
                    <div class="ai-reason">"${data.reason}"</div>
                `;
            } catch (e) { panel.innerText = "Research Failed. Check Bridge."; }
        }
        init();
    </script>
</body>
</html>
