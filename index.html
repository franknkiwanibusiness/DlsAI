<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scout Pro</title>
    <style>
        :root { --bg: #f8fafc; --panel: #ffffff; --text: #1e293b; --accent: #2563eb; --border: #e2e8f0; --safe: #10b981; }
        body.dark { --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --accent: #38bdf8; --border: #334155; }
        
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; }
        .header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 16px; cursor: pointer; transition: 0.2s; }
        .card.active { border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .odds-row { display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .best-mkt { color: var(--safe); font-weight: 700; font-size: 0.9em; }
        
        .report { display: none; margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 4px; font-size: 0.85em; line-height: 1.4; border-left: 3px solid var(--accent); }
        
        .slip { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel); border-top: 2px solid var(--accent); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .payout { font-size: 1.5em; font-weight: 800; color: var(--safe); }
    </style>
</head>
<body class="dark">

<div class="header">
    <div style="font-weight: 800; letter-spacing: -0.5px;">AI SCOUT <span style="font-weight: 400; opacity: 0.5;">PRO</span></div>
    <div id="status" style="font-size: 0.75em; opacity: 0.6;">Syncing...</div>
</div>

<div class="container">
    <div id="matches" class="grid"></div>
</div>

<div class="slip">
    <div>
        <div style="font-size: 0.7em; opacity: 0.6;">MULTIPLIER ODDS</div>
        <div id="totalOdds" style="font-weight: 700;">1.00</div>
    </div>
    <div style="text-align: right;">
        <div style="font-size: 0.7em; opacity: 0.6;">EST. PAYOUT (R<span id="stakeVal">10</span>)</div>
        <div id="payout" class="payout">R0.00</div>
    </div>
</div>

<script>
    const ODDS_KEY = '826ccd6998728ab23f00ac7ad0546c2b';
    let selections = new Map();
    let stake = localStorage.getItem('stake') || 10;

    async function init() {
        document.getElementById('stakeVal').innerText = stake;
        const cache = localStorage.getItem('scout_v7');
        if (cache) {
            const p = JSON.parse(cache);
            if (Date.now() - p.ts < 3600000) return render(p.data); // 1 hour cache
        }
        fetchOdds();
    }

    async function fetchOdds() {
        try {
            const res = await fetch(`https://api.the-odds-api.com/v4/sports/upcoming/odds/?apiKey=${ODDS_KEY}&regions=uk&markets=h2h&oddsFormat=decimal`);
            const data = await res.json();
            localStorage.setItem('scout_v7', JSON.stringify({ ts: Date.now(), data }));
            render(data);
            document.getElementById('status').innerText = "Live Sync Complete";
        } catch (e) { document.getElementById('status').innerText = "Sync Error"; }
    }

    function render(data) {
        document.getElementById('matches').innerHTML = data.map((m, i) => {
            const odds = m.bookmakers[0]?.markets[0]?.outcomes || [];
            const fav = odds.reduce((prev, curr) => (prev.price < curr.price) ? prev : curr, {price: 0});
            return `
                <div class="card" id="m-${i}" onclick="select(${i}, ${fav.price}, '${m.home_team}', '${m.away_team}')">
                    <div style="font-size: 0.7em; opacity: 0.5; margin-bottom: 4px;">${m.sport_title}</div>
                    <div style="font-weight: 600;">${m.home_team} v ${m.away_team}</div>
                    <div class="odds-row">
                        <div class="best-mkt">Likely: ${fav.name}</div>
                        <div style="font-weight: 700;">@${fav.price}</div>
                    </div>
                    <div class="report" id="rep-${i}"></div>
                </div>`;
        }).join('');
    }

    function select(id, price, h, a) {
        const card = document.getElementById(`m-${id}`);
        const rep = document.getElementById(`rep-${id}`);
        if (selections.has(id)) {
            selections.delete(id);
            card.classList.remove('active');
            rep.style.display = 'none';
        } else {
            selections.set(id, price);
            card.classList.add('active');
            rep.style.display = 'block';
            rep.innerText = "Consulting Scout...";
            fetchReport(h, a, id);
        }
        calc();
    }

    async function fetchReport(h, a, id) {
        const box = document.getElementById(`rep-${id}`);
        try {
            const res = await fetch('/api/scout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ home: h, away: a })
            });
            const data = await res.json();
            box.innerText = data.report;
        } catch (e) { box.innerText = "Market stable."; }
    }

    function calc() {
        let total = 1;
        selections.forEach(v => total *= v);
        if (selections.size === 0) total = 0;
        document.getElementById('totalOdds').innerText = total.toFixed(2);
        let p = Math.min(total * stake, 2000000);
        document.getElementById('payout').innerText = "R" + p.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    init();
</script>
</body>
</html>
