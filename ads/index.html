<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NKIWANI V2 ENGINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --cyan: #00ffff; --bg: #000; --panel: #111; --border: #333; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; margin: 0; overflow-x: hidden; }

        /* THE MODAL */
        .vision-modal-fs {
            position: fixed; inset: 0; background: var(--bg);
            display: none; flex-direction: column; z-index: 9999;
        }
        .vision-modal-fs.active { display: flex; }

        /* HEADER & AD AREA */
        .chat-header-fs {
            flex-shrink: 0; background: #000; border-bottom: 1px solid var(--panel);
            position: sticky; top: 0; z-index: 100;
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
        .sticky-ad-raw { width: 100%; min-height: 50px; background: #080808; display: flex; justify-content: center; border-top: 1px solid #111; overflow: hidden; }

        /* CHAT BODY */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth; background: #050505;
        }

        /* BUBBLES */
        .message-wrapper { display: flex; width: 100%; margin-bottom: 10px; }
        .ai-align { justify-content: flex-start; }
        .user-align { justify-content: flex-end; }
        
        .bubble { 
            max-width: 80%; padding: 12px; border-radius: 12px; 
            font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; 
        }
        .ai-bubble { background: #111; border: 1px solid rgba(0,255,255,0.2); border-bottom-left-radius: 2px; }
        .user-bubble { background: var(--cyan); color: #000; font-weight: 600; border-bottom-right-radius: 2px; }

        /* INPUT AREA */
        .chat-footer-fs { padding: 15px; background: #000; border-top: 1px solid var(--panel); }
        .input-box { 
            display: flex; background: #111; border: 1px solid var(--border); 
            border-radius: 12px; padding: 5px 15px; 
        }
        .input-box input { 
            flex: 1; background: transparent; border: none; color: white; 
            height: 40px; outline: none; 
        }
        .send-btn { background: none; border: none; cursor: pointer; color: var(--cyan); }

        /* ADS IN CHAT */
        .chat-ad-inline { margin: 15px 0; border: 1px solid #222; border-radius: 15px; overflow: hidden; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div style="padding: 50px; text-align: center;">
    <button id="askAiBtn" style="padding: 15px 30px; background: var(--cyan); border: none; border-radius: 8px; font-weight: 800; cursor: pointer;">
        START NKIWANI V2
    </button>
</div>

<div id="chatModal" class="vision-modal-fs">
    <div class="chat-header-fs">
        <div class="header-top-row">
            <div style="display: flex; gap: 10px; align-items: center;">
                <img id="chatUserPfp" src="https://via.placeholder.com/32" style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--cyan);">
                <div>
                    <h3 id="chatUsernameDisplay" style="font-size: 0.75rem; margin: 0; letter-spacing: 1px;">USER</h3>
                    <p style="font-size: 0.55rem; color: var(--cyan); margin: 0; font-weight: 800;">ENGINE V2 ACTIVE</p>
                </div>
            </div>
            <button id="closeChatBtn" style="background:none; border:none; color:#555; font-size: 20px;">&times;</button>
        </div>
        
        <div class="sticky-ad-raw" id="headerAd">
             <div style="color: #222; font-size: 10px; align-self: center;">ADVERTISEMENT</div>
        </div>
    </div>

    <div id="chatContainer"></div>

    <div class="chat-footer-fs">
        <form id="chatForm" class="input-box">
            <input type="text" id="chatInput" placeholder="Command NKIWANI V2..." autocomplete="off">
            <button type="submit" class="send-btn">SEND</button>
        </form>
    </div>
</div>

<script type="module">
    // 1. FIREBASE IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // PASTE YOUR CONFIG OBJECT HERE
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const AI_NAME = "@NKIWANI AI V2";
    const AI_PFP = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTzVSbd57etdSJc7XQWpZLhwdMYyys0f-yfx-eN1g-BxNcy0ZLRVn-mjR3X&s=10";

    // 2. AD ENGINE (Standalone Logic)
    function initAdEngine() {
        onValue(ref(db, 'ads'), (snap) => {
            const data = snap.val();
            if(!data) return;
            const ads = Object.values(data);
            const ad = ads[Math.floor(Math.random() * ads.length)];
            document.getElementById('headerAd').innerHTML = `
                <a href="${ad.url}" target="_blank" style="width:100%; height:50px; display:block;">
                    <img src="${ad.image}" style="width:100%; height:100%; object-fit:cover;">
                </a>`;
        });
    }

    // 3. CHAT ENGINE
    const modal = document.getElementById('chatModal');
    const container = document.getElementById('chatContainer');
    const chatInput = document.getElementById('chatInput');
    let messageCounter = 0;

    function appendMessage(role, text, typing = false) {
        const id = 'msg-' + Date.now();
        const isAi = role === 'ai';
        const html = `
            <div id="${id}" class="message-wrapper ${isAi ? 'ai-align' : 'user-align'}">
                <div class="bubble ${isAi ? 'ai-bubble' : 'user-bubble'}">${typing ? '' : text}</div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
        
        if(typing) {
            let i = 0;
            const p = document.getElementById(id).querySelector('.bubble');
            const interval = setInterval(() => {
                p.textContent += text.charAt(i);
                i++;
                container.scrollTop = container.scrollHeight;
                if(i >= text.length) clearInterval(interval);
            }, 15);
        }
        container.scrollTop = container.scrollHeight;
        return id;
    }

    // 4. MAIN LOGIC
    document.getElementById('askAiBtn').onclick = () => modal.classList.add('active');
    document.getElementById('closeChatBtn').onclick = () => modal.classList.remove('active');

    document.getElementById('chatForm').onsubmit = async (e) => {
        e.preventDefault();
        const msg = chatInput.value.trim();
        if(!msg) return;

        appendMessage('user', msg);
        chatInput.value = '';
        messageCounter++;

        // Fake AI response for this demo - connect your /api/aichat here
        setTimeout(() => {
            appendMessage('ai', "SYSTEM READY. ANALYZING SQUAD DATA...", true);
            if(messageCounter % 3 === 0) injectInChatAd();
        }, 1000);
    };

    function injectInChatAd() {
        get(ref(db, 'ads')).then(snap => {
            const ads = Object.values(snap.val());
            const ad = ads[Math.floor(Math.random() * ads.length)];
            container.insertAdjacentHTML('beforeend', `
                <div class="chat-ad-inline">
                    <img src="${ad.image}" style="width:100%; height:150px; object-fit:cover;">
                    <a href="${ad.url}" target="_blank" style="display:block; background:#fff; color:#000; text-align:center; padding:10px; font-weight:800; text-decoration:none;">VISIT SPONSOR</a>
                </div>`);
        });
    }

    onAuthStateChanged(auth, (user) => {
        if(user) {
            initAdEngine();
            // Sync user details to header...
        }
    });
</script>
</body>
</html>
