<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>DLS Audit Tiers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=JetBrains+Mono&display=swap');
        
        body { font-family: 'Space Grotesk', sans-serif; height: 100dvh; overflow: hidden; transition: background 0.5s ease; margin: 0; }
        .glass { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* THEMES */
        body.theme-noob { background: #2d1b0d; } 
        body.theme-pro { background: #020617; }  
        body.theme-hacker { background: #000000; } 

        /* FIX: SCAN ANIMATION */
        #scanner {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #4ade80;
            box-shadow: 0 0 15px #4ade80;
            top: 0;
            z-index: 20;
            display: none; /* Controlled by JS */
        }
        
        @keyframes scanAnim {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        .glitch-text { text-shadow: 2px 0 #ff00c1, -2px 0 #00fff9; animation: glitch 2s infinite; }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-1px, 1px); }
            40% { transform: translate(-1px, -1px); }
            60% { transform: translate(1px, 1px); }
            80% { transform: translate(1px, -1px); }
            100% { transform: translate(0); }
        }

        .typing::after { content: 'â–‹'; animation: blink 1s infinite; color: #4ade80; margin-left: 2px; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="theme-noob text-slate-100 flex flex-col">

    <header class="glass m-3 p-4 rounded-3xl flex justify-between items-center z-50">
        <div>
            <p id="tier-label" class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Noob Valuation</p>
            <h2 id="total-valuation" class="text-3xl font-bold text-green-400">$0.00</h2>
        </div>
        <div class="flex flex-col items-end gap-1">
            <select id="engine-select" onchange="updateTheme()" class="bg-black/40 text-xs p-2 rounded-xl border border-white/10 outline-none">
                <option value="dlsvaluenoob">NOOB (2 Tokens)</option>
                <option value="dlsvaluepro">PRO (4 Tokens)</option>
                <option value="dlsvaluehacker">HACKER (5 Tokens)</option>
            </select>
            <span id="token-cost" class="text-[9px] font-mono text-white/50 uppercase">Cost: 2 Tokens</span>
        </div>
    </header>

    <main id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4 pb-44">
        <div class="glass p-4 rounded-2xl text-sm border-l-4 border-amber-800" id="welcome-bubble">
            System Initialized. Upload squad screenshot for valuation.
        </div>
    </main>

    <div id="sale-overlay" class="hidden fixed bottom-32 left-4 right-4 z-40">
        <button onclick="generateSale()" class="w-full bg-white text-black font-bold py-4 rounded-2xl shadow-2xl flex items-center justify-center gap-2 uppercase tracking-tighter hover:scale-95 transition-transform">
            <i class="fa-solid fa-bolt"></i> Generate Sale ID
        </button>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/80 to-transparent">
        <div id="preview-box" class="hidden relative w-24 h-24 mb-4 rounded-2xl overflow-hidden border-2 border-white/20">
            <div id="scanner"></div>
            <img id="image-preview" class="w-full h-full object-cover" />
        </div>

        <div class="glass rounded-3xl p-2 flex items-center gap-2">
            <label class="p-4 cursor-pointer hover:bg-white/5 rounded-2xl transition-colors">
                <i class="fa-solid fa-camera text-xl text-slate-400"></i>
                <input type="file" id="file-input" class="hidden" accept="image/*" />
            </label>
            <div id="status" class="flex-1 text-sm font-mono opacity-50 truncate italic px-2">AWAIT_IMAGE...</div>
            <button id="send-btn" disabled class="bg-white text-black font-black h-12 px-8 rounded-2xl disabled:opacity-20 transition-all uppercase italic">
                Scan
            </button>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const engineSelect = document.getElementById('engine-select');
        const tokenLabel = document.getElementById('token-cost');
        const tierLabel = document.getElementById('tier-label');
        const body = document.body;
        const sendBtn = document.getElementById('send-btn');
        const scanner = document.getElementById('scanner');

        function updateTheme() {
            const engine = engineSelect.value;
            body.className = 'text-slate-100 flex flex-col '; // Reset
            
            if(engine === 'dlsvaluenoob') {
                body.classList.add('theme-noob');
                tokenLabel.innerText = "COST: 2 TOKENS";
                tierLabel.innerText = "Noob Valuation";
                tierLabel.classList.remove('glitch-text');
            } else if(engine === 'dlsvaluepro') {
                body.classList.add('theme-pro');
                tokenLabel.innerText = "COST: 4 TOKENS";
                tierLabel.innerText = "Diamond Pro Audit";
                tierLabel.classList.remove('glitch-text');
            } else if(engine === 'dlsvaluehacker') {
                body.classList.add('theme-hacker');
                tokenLabel.innerText = "COST: 5 TOKENS";
                tierLabel.innerText = "Hacker Ghost Scan";
                tierLabel.classList.add('glitch-text');
            }
        }

        let currentBase64 = null;
        const fileInput = document.getElementById('file-input');
        
        fileInput.onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentBase64 = ev.target.result;
                document.getElementById('image-preview').src = currentBase64;
                document.getElementById('preview-box').classList.remove('hidden');
                sendBtn.disabled = false;
                document.getElementById('status').innerText = "DATA_READY";
                document.getElementById('status').classList.remove('italic');
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function typeEffect(element, text) {
            let i = 0;
            element.innerHTML = ""; // Clear bubble
            element.classList.add('typing');
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                } else {
                    clearInterval(timer);
                    element.classList.remove('typing');
                }
            }, 10); // Speed of typing
        }

        sendBtn.onclick = async () => {
            const engine = engineSelect.value;
            
            // UI START SCAN
            sendBtn.disabled = true;
            scanner.style.display = 'block';
            scanner.style.animation = "scanAnim 2s infinite linear";
            document.getElementById('status').innerText = "SCANNING_NEURAL_DRIVE...";

            try {
                const res = await fetch(`/api/${engine}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: currentBase64 })
                });
                
                const data = await res.json();
                const report = data.analysis || data.report || "ERROR: NO_RESPONSE";

                // Update Total Value
                const priceMatch = report.match(/\$([0-9]+\.[0-9]{2})/);
                if (priceMatch) {
                    document.getElementById('total-valuation').innerText = `$${priceMatch[1]}`;
                    document.getElementById('sale-overlay').classList.remove('hidden');
                }

                // Create AI Bubble
                const bubbleWrap = document.createElement('div');
                bubbleWrap.className = 'flex justify-start w-full';
                const bubble = document.createElement('div');
                bubble.className = 'glass p-5 rounded-3xl mono text-[12px] leading-relaxed border-white/5 shadow-2xl max-w-[90%]';
                bubbleWrap.appendChild(bubble);
                chatWindow.appendChild(bubbleWrap);
                
                // Start Typewriter
                typeEffect(bubble, report);

            } catch (err) {
                alert("CRITICAL: ENGINE_OFFLINE");
            } finally {
                sendBtn.disabled = false;
                scanner.style.display = 'none';
                scanner.style.animation = "none";
                document.getElementById('preview-box').classList.add('hidden');
                document.getElementById('status').innerText = "SCAN_COMPLETE";
            }
        };

        async function generateSale() {
            // Placeholder for your Firebase Sale Link Logic
            alert("Sale Link generated and saved to Firebase!");
        }

        // Initialize Theme
        updateTheme();
    </script>
</body>
</html>
